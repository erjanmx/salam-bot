[![Build Status](https://travis-ci.org/erjanmx/salam-bot.svg?branch=master)](https://travis-ci.org/erjanmx/salam-bot)

 # Салам бот <img src="salam_bot.png" align="left" height="48" width="48" >



Бот для мессенджера [NambaOne](https://namba1.co/) победивший в конкурсе 'BattleBot' устроенный создателями мессенджера

Позволяет связать двоих случайных пользователей в один чат позволяя им общаться между собой не раскрывая свои настоящие личности

### Как работает

#### Поиск собеседника 

По команде пользователя бот находит собеседника среди других активных пользователей бота, стараясь учитывать, чтобы пол собеседника был противоположен, однако если есть активный собеседник того же пола, то будет выбран он (ведь зачем связывать с собеседником противоположного пола если он давно не заходил и не будет отвечать)

#### Мне никто не отвечает

> Bot-API не дает возможности узнать находится ли пользователь в сети (онлайн), поэтому это узнается по косвенным признакам

Активных пользователей данного мессенджера пока очень малое количество, бот пытается связать вас с наиболее активным собеседником, однако это не гарантирует того, что пользователь не закрыл приложение и/или не увидел оповещения о новой беседе.

В боте заложено правило, которое закрывает только что созданный чат если собеседник не ответил в течение трех минут, при этом если собеседник ответил в течение этого времени то этот чат уже никогда не будет автоматически закрыт.

#### Анонимно ли?

Да, все сообщения сразу перенаправляются собеседнику не сохраняясь где-либо на сервере. На сервере хранятся лишь данные пользователей полученных из Bot-API, а так же данные, какой пользователь связан с каким (чтобы бот мог правильно перенаправлять сообщения), при этом как только одна из сторон закрывает беседу эта информация сразу же удаляется из сервера.


#### Демонстрация
![Imgur](http://i.imgur.com/rNPY46j.gif)


## Установка

Приложение работает на [Flask](http://flask.pocoo.org/), в качестве работы с БД используется [orator](https://orator-orm.com/)

### Зависимости

- python3 с pip и virtualenv
- mysql

### Создание и активация virtualenv

```bash
virtualenv venv
source venv/bin/activate
```

### Установка зависимостей

```bash
pip install -r requirements.txt
```

## Запуск

Приложение настраивается через `.env` файл или указав значения в переменных окружения
```bash
cp .env.example .env
```

После задания настроек необходимо запустить команду миграции для создания необходимых таблиц, предварительно создав базу данных

```bash
orator migrate -c config/settings.py -p database/migrations/ -f
```

Если миграции выполнились успешно то можно уже запустить командой

```bash
python app.py
```

После запуска можно отправить запрос 
```bash
curl -X POST \
  http://127.0.0.1:5000?<TOKEN_KEY>=<TOKEN_VALUE> \
  -H 'content-type: application/json' \
  -d '{"event":"cron/close_idle_chats","data":""}'
```

В ответ должно придти 200 Ok c json
```json
{"success": true}
```

### Локализация

Файлы локализации находятся в директории `config/locales`, каждый файл представляет собой локализацию на конкретный язык.

На текущий момент бот поддерживает два языка "кыргызский" и "русский".

Для добавлении нового языка необходимо добавить новый файл `{lang_code}.py` имя которого соответствует ISO коду языка. 
Этот файл должен содержать единственную переменную `locale` который имеет тип `dict` и внутри которого заданы переводы команд и системных сообщений в формате ключ - значение, к примеру

```
'language': 'Русский'
```

Команды для управления ботом могут быть заданы в нескольких вариантах, к примеру как это сделано для команд кыргызского языка для тех, у кого нет букв кыргызского алфавита. 

```
'search': ['издөө', 'издоо']
```

Для активации языков необходимо в `.env` файле указать значение переменной `APP_LANGS` коды языков, есть возможность указать несколько языков через запятую к примеру `ky, ru`
### Закрытие неактивных чатов

Если после создания чата собеседник не ответил в течение трех минут то чат должен быть закрыт с уведомлением обоих сторон

Для этого необходимо поставить вызов по расписанию endpoint-a приложения с соответствующими параметрами, а именно

```bash
curl -X POST \
  'url' \
  -H 'content-type: application/json' \
  -d '{"event":"cron/close_idle_chats","data":""}'
```
